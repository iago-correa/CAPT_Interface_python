{% extends 'login/base.html' %}

{% block content %}
    <h1>Recording Session</h1>

    <button id="completeSessionBtn" class="btn btn-success mb-3" disabled>Complete Session</button>
    <hr>

    <div class="audio-block" data-audio-id="rec_warmup">
        <h3>Recording warm-up</h3>
        <p>I am learning English today.</p>
        <button class="recordBtn btn btn-primary" data-state="idle">Start Recording</button>
        <audio id="warmup_recording" class="mt-2"> Your browser does not support the audio element.</audio>
        <button id="playWarmupBtn" class="btn btn-secondary mt-2" disabled>Play recording</button>
        <hr>
    </div>

    <h3>Recording Tasks</h3>
    {% for item in test_set %}
        <div class="audio-block mb-3 p-3 border rounded" data-audio-id="{{ item.audio.id }}" data-recorded-initially="{{ item.is_recorded|yesno:'true,false' }}">
            <p>
                <input type="checkbox" class="is-recorded-indicator" style="margin-right: 5px;" {% if item.is_recorded %}checked{% endif %} disabled />
                <strong>Task {{ forloop.counter }}:</strong> {{ item.audio.transcript }}
            </p>
            <button class="recordBtn btn {% if item.is_recorded %}btn-secondary{% else %}btn-danger{% endif %}" data-state="idle" {% if item.is_recorded %}disabled{% endif %}>
                {% if item.is_recorded %}Recorded{% else %}Start Recording{% endif %}
            </button>
        </div>
    {% endfor %}
    {% if not test_set %}
        <p>No recording tasks available for this session.</p>
    {% endif %}

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let currentAudioIdForRecording = null;
        let activeButton = null;
        let warmupAudioUrl = null;

        const currentT = {{ current_t }};
        let clientActivityType;
        if (currentT === 0) {
            clientActivityType = 'test_pre_record';
        } else if (currentT === 2) {
            clientActivityType = 'test_post_record';
        } else if (currentT === 3) {
            clientActivityType = 'test_delay_record';
        } else {
            clientActivityType = 'unknown_test_type';
        }

        let audioCompletionStatus = {};
        const audioBlocksToTrack = document.querySelectorAll('.audio-block[data-audio-id]:not([data-audio-id="rec_warmup"])');
        const totalAudiosToRecord = audioBlocksToTrack.length;
        const csrfToken = '{{ csrf_token_value }}';

        function updateCompleteSessionButtonState() {
            const completeBtn = document.getElementById('completeSessionBtn');
            if (!completeBtn) return;
            if (totalAudiosToRecord === 0 && {% if not test_set %}true{% else %}false{% endif %}) {
                 completeBtn.disabled = true;
                 return;
            }
            const recordedCount = Object.values(audioCompletionStatus).filter(status => status).length;
            completeBtn.disabled = (recordedCount < totalAudiosToRecord);
        }

        document.addEventListener('DOMContentLoaded', () => {
            audioBlocksToTrack.forEach(audioBlock => {
                const audioId = audioBlock.dataset.audioId;
                const isRecordedInitially = audioBlock.dataset.recordedInitially === 'true';
                audioCompletionStatus[audioId] = isRecordedInitially;
            });
            updateCompleteSessionButtonState();

            document.getElementById('playWarmupBtn').onclick = () => {
                const warmupAudioPlayer = document.getElementById('warmup_recording');
                if (warmupAudioPlayer.src) {
                    warmupAudioPlayer.play();
                }
            };

            const completeBtn = document.getElementById('completeSessionBtn');
            if (completeBtn) {
                completeBtn.onclick = () => {
                    window.location.href = "{% url 'login:logout' %}?message=" + encodeURIComponent("セッション完了しました。ご協力ありがとうございました。");
                };
            }
        });

        function setButtonsDisabledState(shouldBeDisabled, exceptThisButton = null) {
            document.querySelectorAll('button.recordBtn, button#playWarmupBtn').forEach(btn => {
                if (btn === exceptThisButton) return;
                btn.disabled = shouldBeDisabled;
            });
            if (!shouldBeDisabled) { // Re-evaluate specific disabled states if enabling all
                enableAppropriateUIButtons();
            }
        }
        
        function enableAppropriateUIButtons() {
            const warmupRecordBtn = document.querySelector('.audio-block[data-audio-id="rec_warmup"] .recordBtn');
            if (warmupRecordBtn && warmupRecordBtn.getAttribute('data-state') === 'idle') {
                warmupRecordBtn.disabled = false;
            }
        
            document.getElementById('playWarmupBtn').disabled = !warmupAudioUrl;
        
            audioBlocksToTrack.forEach(audioBlock => {
                const audioId = audioBlock.dataset.audioId;
                const recordBtn = audioBlock.querySelector('.recordBtn');
                if (recordBtn && recordBtn.getAttribute('data-state') === 'idle') {
                    recordBtn.disabled = audioCompletionStatus[audioId];
                }
            });
            updateCompleteSessionButtonState();
        }


        document.querySelectorAll('.recordBtn').forEach(recordBtn => {
            recordBtn.onclick = async () => {
                activeButton = recordBtn; // Store the button that was clicked
                currentAudioIdForRecording = activeButton.closest('.audio-block').dataset.audioId;
                const state = activeButton.getAttribute('data-state');

                if (state === 'idle') {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        let recorderMimeType = 'audio/webm;codecs=opus'; // A common default
                        if (MediaRecorder.isTypeSupported('audio/wav')) {
                             recorderMimeType = 'audio/wav';
                        } else if (!MediaRecorder.isTypeSupported(recorderMimeType) && MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                            recorderMimeType = 'audio/ogg;codecs=opus';
                        } else if (!MediaRecorder.isTypeSupported(recorderMimeType)) {
                            recorderMimeType = ''; // Let browser pick its absolute default
                        }
                        
                        mediaRecorder = recorderMimeType ? new MediaRecorder(stream, { mimeType: recorderMimeType }) : new MediaRecorder(stream);
                        console.log("Using MediaRecorder mimeType:", mediaRecorder.mimeType);

                        audioChunks = [];

                        if (currentAudioIdForRecording === 'rec_warmup') {
                            if (warmupAudioUrl) URL.revokeObjectURL(warmupAudioUrl);
                            warmupAudioUrl = null;
                            document.getElementById('warmup_recording').src = '';
                            document.getElementById('playWarmupBtn').disabled = true;
                        }

                        setButtonsDisabledState(true, activeButton);
                        activeButton.textContent = 'Stop Recording';
                        activeButton.setAttribute('data-state', 'recording');
                        activeButton.disabled = false; // Ensure the stop button itself is active

                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                        mediaRecorder.onstop = async () => {
                            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'application/octet-stream' });
                            audioChunks = [];

                            if (currentAudioIdForRecording === 'rec_warmup') {
                                warmupAudioUrl = URL.createObjectURL(blob);
                                document.getElementById('warmup_recording').src = warmupAudioUrl;
                                document.getElementById('playWarmupBtn').disabled = false; // Enable play
                                console.log("Warm-up audio recorded. Ready for client-side playback.");
                            } else {
                                const formData = new FormData();
                                let fileExtension = (mediaRecorder.mimeType.split(';')[0].split('/')[1]) || 'bin';
                                formData.append('audio', blob, `${clientActivityType}_${currentAudioIdForRecording}.${fileExtension}`);
                                formData.append('reference_audio', currentAudioIdForRecording);
                                formData.append('activity_type', clientActivityType);

                                try {
                                    const response = await fetch(`/record/${currentT}/`, {
                                        method: 'POST',
                                        body: formData,
                                        headers: { 'X-CSRFToken': csrfToken }
                                    });
                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        console.log(`Successfully recorded audio ID: ${currentAudioIdForRecording}`);
                                        audioCompletionStatus[currentAudioIdForRecording] = true;
                                        const recordedBlock = document.querySelector(`.audio-block[data-audio-id="${currentAudioIdForRecording}"]`);
                                        if (recordedBlock) {
                                            const btn = recordedBlock.querySelector('.recordBtn');
                                            if (btn) {
                                                btn.textContent = 'Recorded';
                                                btn.disabled = true;
                                                btn.classList.remove('btn-danger');
                                                btn.classList.add('btn-secondary');
                                            }
                                            const indicator = recordedBlock.querySelector('.is-recorded-indicator');
                                            if (indicator) indicator.checked = true;
                                        }
                                    } else {
                                        console.error(`Server error for audio ID ${currentAudioIdForRecording}: ${data.message || response.statusText} (Status: ${response.status})`);
                                        alert(`Error saving recording for ${currentAudioIdForRecording}: ${data.message || response.statusText}`);
                                    }
                                } catch (error) {
                                    console.error(`Fetch error for /record/ on audio ID ${currentAudioIdForRecording}:`, error);
                                    alert(`Network error or issue processing recording for ${currentAudioIdForRecording}: ${error}. Please try again.`);
                                }
                            }
                            
                            if(activeButton){
                                activeButton.textContent = (currentAudioIdForRecording !== 'rec_warmup' && audioCompletionStatus[currentAudioIdForRecording]) ? 'Recorded' : 'Start Recording';
                                activeButton.setAttribute('data-state', 'idle');
                                if (currentAudioIdForRecording !== 'rec_warmup' && audioCompletionStatus[currentAudioIdForRecording]) {
                                     activeButton.disabled = true;
                                } else if (currentAudioIdForRecording === 'rec_warmup'){
                                    activeButton.disabled = false; // Warmup record button can be re-enabled
                                }
                            }
                            setButtonsDisabledState(false); // Re-enable appropriate buttons
                            activeButton = null;
                        };
                        mediaRecorder.start();
                    } catch (err) {
                        console.error("Error starting recording:", err);
                        if (activeButton) {
                           activeButton.textContent = 'Start Recording';
                           activeButton.setAttribute('data-state', 'idle');
                        }
                        setButtonsDisabledState(false);
                        alert("Could not start recording. Please check microphone permissions.");
                        activeButton = null;
                    }
                } else if (state === 'recording') { // Clicked "Stop Recording"
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        activeButton.textContent = 'Stopping...'; // Immediate feedback
                        activeButton.disabled = true; // Prevent multi-clicks on stop
                        mediaRecorder.stop();
                    } else if (mediaRecorder && mediaRecorder.state === "inactive") {
                        console.warn("Stop clicked but mediaRecorder was already inactive.");
                         // This means onstop might have already run or is about to run.
                         // Let onstop handle final UI reset.
                    } else {
                        console.warn("Stop called but mediaRecorder not in recording state or null.", mediaRecorder ? mediaRecorder.state : 'null');
                        if (activeButton) { // Fallback UI reset if something went wrong
                            activeButton.textContent = 'Start Recording';
                            activeButton.setAttribute('data-state', 'idle');
                            activeButton.disabled = (currentAudioIdForRecording !== 'rec_warmup' && audioCompletionStatus[currentAudioIdForRecording]);
                        }
                        setButtonsDisabledState(false);
                        activeButton = null;
                    }
                }
            };
        });
    </script>
{% endblock %}