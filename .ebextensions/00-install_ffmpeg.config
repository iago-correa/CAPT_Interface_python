# .ebextensions/00_install_ffmpeg.config
commands:
  01_install_static_ffmpeg:
    # This command downloads a static build of FFmpeg, extracts it,
    # and places the ffmpeg (and ffprobe) executables into /usr/local/bin.
    command: |
      if [ ! -f /usr/local/bin/ffmpeg ]; then
        echo "FFmpeg not found, downloading and installing static build..."
        cd /tmp
        curl -LO https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        
        if [ -f ffmpeg-release-amd64-static.tar.xz ]; then
          echo "Download complete. Extracting..."
          tar -xf ffmpeg-release-amd64-static.tar.xz
          if [ -d ffmpeg-release-amd64-static ]; then
            echo "Extraction complete. Moving executables..."
            sudo mv ffmpeg-release-amd64-static/ffmpeg /usr/local/bin/
            sudo mv ffmpeg-release-amd64-static/ffprobe /usr/local/bin/ # ffprobe is often useful with ffmpeg
            sudo chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
            echo "FFmpeg installed to /usr/local/bin/"
          else
            echo "ERROR: Extracted directory not found!"
            exit 1 # Cause the command to fail if extraction didn't work as expected
          fi
          rm -rf ffmpeg-release-amd64-static* # Clean up downloaded archive and extracted folder
        else
          echo "ERROR: Failed to download FFmpeg static build!"
          exit 1 # Cause the command to fail if download failed
        fi
      else
        echo "FFmpeg already found at /usr/local/bin/ffmpeg. Skipping installation."
      fi
    # The 'test' condition is now handled inside the command script itself.

  02_verify_ffmpeg_install:
    # This command verifies that ffmpeg was installed correctly and is in the system's PATH.
    command: "/usr/local/bin/ffmpeg -version"