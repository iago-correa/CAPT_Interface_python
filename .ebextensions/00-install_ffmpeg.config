# .ebextensions/00_install_ffmpeg.config
commands:
  01_install_static_ffmpeg:
    # This command downloads a static build of FFmpeg, extracts it,
    # and places the ffmpeg (and ffprobe) executables into /usr/local/bin.
    # IMPORTANT: The URL below is an example for FFmpeg 6.0.
    # You should verify the latest stable release and URL from a trusted source like
    # John Van Sickle's site (johnvansickle.com/ffmpeg/) or the official FFmpeg download page (ffmpeg.org).
    # Always download from trusted sources.
    command: |
      if [ ! -f /usr/local/bin/ffmpeg ]; then
        echo "FFmpeg not found, downloading and installing static build..."
        cd /tmp
        # Example URL for FFmpeg 6.0 amd64 static build. REPLACE with a current, trusted URL.
        curl -LO https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        
        if [ -f ffmpeg-release-amd64-static.tar.xz ]; then
          echo "Download complete. Extracting..."
          tar -xf ffmpeg-release-amd64-static.tar.xz
          # The extracted folder name should match the downloaded file name (e.g., ffmpeg-6.0-amd64-static)
          if [ -d ffmpeg-6.0-amd64-static ]; then
            echo "Extraction complete. Moving executables..."
            sudo mv ffmpeg-6.0-amd64-static/ffmpeg /usr/local/bin/
            sudo mv ffmpeg-6.0-amd64-static/ffprobe /usr/local/bin/ # ffprobe is often useful with ffmpeg
            sudo chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
            echo "FFmpeg installed to /usr/local/bin/"
          else
            echo "ERROR: Extracted directory not found!"
            exit 1 # Cause the command to fail if extraction didn't work as expected
          fi
          rm -rf ffmpeg-6.0-amd64-static* # Clean up downloaded archive and extracted folder
        else
          echo "ERROR: Failed to download FFmpeg static build!"
          exit 1 # Cause the command to fail if download failed
        fi
      else
        echo "FFmpeg already found at /usr/local/bin/ffmpeg. Skipping installation."
      fi
    # The 'test' condition is now handled inside the command script itself.

  02_verify_ffmpeg_install:
    # This command verifies that ffmpeg was installed correctly and is in the system's PATH.
    command: "/usr/local/bin/ffmpeg -version"