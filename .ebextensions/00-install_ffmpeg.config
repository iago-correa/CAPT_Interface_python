# .ebextensions/00_install_ffmpeg.config
commands:
  01_install_rpmfusion_al2023:
    # For Amazon Linux 2023, we install RPM Fusion for a recent compatible Fedora version.
    # Fedora 39 is a reasonable choice as AL2023 aligns with modern Fedora releases.
    # Using --nogpgcheck can bypass GPG key issues if the keys aren't automatically imported.
    # This command attempts to install both the free and nonfree RPM Fusion repositories.
    command: |
      sudo dnf install -y --nogpgcheck https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-39.noarch.rpm
      sudo dnf install -y --nogpgcheck https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-39.noarch.rpm
    # Test if the RPM Fusion free repository configuration file exists.
    test: "test ! -f /etc/yum.repos.d/rpmfusion-free.repo"

  02_install_ffmpeg_al2023:
    # Once RPM Fusion repositories are configured, ffmpeg should be available.
    # We install ffmpeg and ffmpeg-libs (which pydub might need).
    command: "sudo dnf install -y ffmpeg ffmpeg-libs"
    # Only run if ffmpeg isn't already installed.
    test: "test ! -f /usr/bin/ffmpeg"

  03_verify_ffmpeg_install:
    # This command helps verify that ffmpeg was installed correctly and is in the system's PATH.
    # If ffmpeg is not found, this command will error out and halt the deployment,
    # clearly indicating that the ffmpeg installation step failed.
    command: "ffmpeg -version"