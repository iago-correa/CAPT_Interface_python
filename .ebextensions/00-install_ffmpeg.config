# .ebextensions/00_install_ffmpeg.config
commands:
  01_install_static_ffmpeg:
    command: |
      if [ ! -f /usr/local/bin/ffmpeg ]; then
        echo "FFmpeg not found, downloading and installing static build..."
        cd /tmp
        
        ARCHIVE_NAME="ffmpeg-release-amd64-static.tar.xz"
        DOWNLOAD_URL="https://johnvansickle.com/ffmpeg/releases/${ARCHIVE_NAME}"

        echo "Downloading from ${DOWNLOAD_URL}..."
        curl -LO "${DOWNLOAD_URL}"
        
        if [ -f "${ARCHIVE_NAME}" ]; then
          echo "Download complete. Extracting ${ARCHIVE_NAME}..."
          tar -xf "${ARCHIVE_NAME}"
          
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "ffmpeg-*-amd64-static" -print -quit)
          
          if [ -n "$EXTRACTED_DIR" ] && [ -d "$EXTRACTED_DIR" ] && [ -f "$EXTRACTED_DIR/ffmpeg" ]; then
            # Remove './' prefix if find adds it
            CLEAN_EXTRACTED_DIR=${EXTRACTED_DIR#./}
            echo "Found extracted directory: ${CLEAN_EXTRACTED_DIR}. Moving executables..."
            
            sudo mv "${CLEAN_EXTRACTED_DIR}/ffmpeg" /usr/local/bin/
            sudo mv "${CLEAN_EXTRACTED_DIR}/ffprobe" /usr/local/bin/ # ffprobe is often useful with ffmpeg
            sudo chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
            echo "FFmpeg installed to /usr/local/bin/"
            
            echo "Cleaning up downloaded files..."
            rm -f "${ARCHIVE_NAME}"
            rm -rf "${CLEAN_EXTRACTED_DIR}" # Remove the extracted folder
          else
            echo "ERROR: Could not find extracted FFmpeg directory or the ffmpeg executable within it using wildcard 'ffmpeg-*-amd64-static'."
            echo "Listing contents of /tmp to help debug:"
            ls -lah /tmp
            # Clean up the downloaded archive even if extraction failed to prevent issues on retry
            rm -f "${ARCHIVE_NAME}"
            exit 1 # Cause the command to fail if extraction or file move didn't work as expected
          fi
        else
          echo "ERROR: Failed to download FFmpeg static build! Archive ${ARCHIVE_NAME} not found."
          exit 1 # Cause the command to fail if download failed
        fi
      else
        echo "FFmpeg already found at /usr/local/bin/ffmpeg. Skipping installation."
      fi

  02_verify_ffmpeg_install:
    # This command verifies that ffmpeg was installed correctly and is in the system's PATH.
    command: "/usr/local/bin/ffmpeg -version"