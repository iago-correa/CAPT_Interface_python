# .ebextensions/00_install_ffmpeg.config
commands:
  01_install_epel_for_al2023:
    # Installs EPEL (Extra Packages for Enterprise Linux) for EL9, which AL2023 is compatible with.
    command: |
      echo "Installing EPEL release for AL2023 (EL9 compatible)"
      sudo dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    # Test: Run this command only if the epel.repo configuration file does not already exist.
    test: "test ! -f /etc/yum.repos.d/epel.repo"

  02_enable_crb_al2023:
    # Enables the CodeReady Builder (CRB) repository. Some EPEL packages depend on it.
    # AL2023 uses 'crb' as an alias for what was 'powertools' or 'codeready-builder' in other EL distributions.
    command: "sudo dnf config-manager --set-enabled crb || echo 'CRB repository not found or could not be enabled, this might be okay for ffmpeg.'"
    # This command runs to ensure CRB is enabled if present. The '|| echo' part allows the script to continue if CRB isn't applicable or fails to enable,
    # as it's not always strictly required for all EPEL/RPMFusion packages but is good practice to try.

  03_install_rpm_fusion_for_el9_al2023:
    # Installs RPM Fusion (free and nonfree) repositories for EL9.
    command: |
      echo "Installing RPM Fusion (free and nonfree) for EL9 on AL2023"
      sudo dnf install -y --nogpgcheck https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-9.noarch.rpm
      sudo dnf install -y --nogpgcheck https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-9.noarch.rpm
    # Test: Run this command only if the rpmfusion-free.repo configuration file does not already exist.
    test: "test ! -f /etc/yum.repos.d/rpmfusion-free.repo"

  04_install_ffmpeg_al2023:
    # Installs ffmpeg and ffmpeg-libs from the now-configured repositories (EPEL/RPM Fusion).
    command: |
      echo "Attempting to install ffmpeg and ffmpeg-libs"
      sudo dnf install -y ffmpeg ffmpeg-libs
    # Test: Run this command only if the ffmpeg executable does not already exist.
    test: "test ! -f /usr/bin/ffmpeg"

  05_verify_ffmpeg_install:
    # This command verifies that ffmpeg was installed correctly and is in the system's PATH.
    # If ffmpeg is not found or fails, this command will error out,
    # which will halt the deployment and clearly indicate that the ffmpeg installation failed.
    command: "ffmpeg -version"