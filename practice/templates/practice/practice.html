{% extends 'login/base.html' %}

{% block content %}
    <h1>Practice Session</h1>

    <button id="completeTrainingBtn" disabled>Complete Training</button>

    {% for audio, recording in train_set %}
    
        {% csrf_token %}

        <div class="audio-block" data-audio-id="{{ audio.id }}">

            <p>{{ audio.transcript }}</p>

            <audio id="audio_{{ audio.id }}">
                <source src="{{ audio.file.url }}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
            
            <button onclick="document.getElementById('audio_{{ audio.id }}').play(); logActivity('{{ audio.id }}', 'train_listen_ref')">Play</button>

            <button class="recordBtn" data-state="idle">Start Recording</button>

            <audio id="recording_{{ recording.id }}">
                <source src="{{ recording.recorded_audio.url }}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
            
            <button onclick="document.getElementById('recording_{{ recording.id }}').play(); logActivity('{{ recording.id }}', 'train_listen_own')">Play recording</button>

        </div>

        <hr>

    {% endfor %}

    <script>
        function logActivity(audioSourceId, typeCode) {
            console.log("Logging activity:", { audioSourceId, typeCode });
            fetch("/practice/log-activity/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    audio_source_id: audioSourceId,
                    type: typeCode
                })
            });

            // Update completion status
            if (typeCode === 'train_listen_ref') {
                updateCompletionStatus(audioSourceId, 'played');
            } 

        }

        let mediaRecorder;
        let audioChunks = [];
        let currentAudioId = null;
        let activity_type = 'train_record';
        let activeButton = null;

        function disableAllButtons(except) {
            document.querySelectorAll('button').forEach(btn => {
                if (btn !== except) btn.disabled = true;
            });
        }

        function enableAllButtons() {
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        document.querySelectorAll('.recordBtn').forEach(recordBtn => {
            const audioBlock = recordBtn.closest('.audio-block');
            const audioId = audioBlock.dataset.audioId;

            recordBtn.onclick = async () => {
                const state = recordBtn.getAttribute('data-state');

                if (state === 'idle') {
                    // Start recording
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    currentAudioId = audioId;
                    activeButton = recordBtn;

                    disableAllButtons(recordBtn);
                    recordBtn.textContent = 'Stop Recording';
                    recordBtn.setAttribute('data-state', 'recording');

                    mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: 'audio/wav' });
                        const formData = new FormData();
                        formData.append('audio', blob, 'recorded.wav');
                        formData.append('reference_audio', currentAudioId);
                        formData.append('activity_type', activity_type);

                        const response = await fetch('/record/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            updateCompletionStatus(currentAudioId, 'recorded');
                            const recording = data.recording;
                            const audioBlock = document.querySelector(`.audio-block[data-audio-id="${currentAudioId}"]`);

                            const audioElement = audioBlock.querySelector('audio[id^="recording_"]');
                            const sourceElement = audioElement.querySelector('source');

                            audioElement.id = `recording_${recording.id}`;
                            sourceElement.src = recording.url;
                            audioElement.load();

                            const playBtn = audioBlock.querySelector('button[onclick*="train_listen_own"]');
                            playBtn.setAttribute('onclick', `document.getElementById('recording_${recording.id}').play(); logActivity('${recording.id}', 'train_listen_own')`);
                        }

                        enableAllButtons();
                        recordBtn.textContent = 'Start Recording';
                        recordBtn.setAttribute('data-state', 'idle');
                        audioChunks = [];
                    };

                    mediaRecorder.start();
                } else {
                    // Stop recording
                    mediaRecorder.stop();
                    activeButton = null;
                }
            };
        });
    
        const audioIds = Array.from(document.querySelectorAll('.audio-block')).map(div => div.dataset.audioId);
        const completedStatus = {};  // {audioId: {played: bool, recorded: bool}}

        audioIds.forEach(id => {
            completedStatus[id] = { played: false, recorded: false };
        });

        function updateCompletionStatus(audioId, actionType) {
            if (actionType === 'played') {
                completedStatus[audioId].played = true;
            } else if (actionType === 'recorded') {
                completedStatus[audioId].recorded = true;
            }

            // Check if all audios were played and recorded
            const allDone = Object.values(completedStatus).every(status => status.played && status.recorded);
            const completeBtn = document.getElementById('completeTrainingBtn');
            completeBtn.disabled = !allDone;

            if (allDone) {
                completeBtn.onclick = () => {
                    window.location.href = "/logout/?message=セッション完了しました。";
                };
            }

        }
    
    </script>


    
{% endblock %}
