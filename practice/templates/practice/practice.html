{% extends 'login/base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h1>練習セッション</h1>

    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">練習の進め方</h4>
        <p>まずお手本の音声（「再生」ボタン）を聞いてから、ご自身の発音を録音（「録音開始」ボタン）してください。録音した音声は「録音を再生」ボタンで確認できます。</p>
        <hr>
        <p class="mb-0">お手本の再生、ご自身の録音、録音の再生は、何度でも繰り返し行うことができます。ただし、各課題で最低一回ずつお手本を聞き、ご自身の音声を録音すると、「セッション完了」ボタンが有効になります。</p>
    </div>

    {% for audio, recording, recording_signed_url in train_set %}
        {% if forloop.first %}{% csrf_token %}{% endif %}
        <div class="audio-block card mb-3" data-audio-id="{{ audio.id }}">
            <div class="card-body">
                <p class="mb-3">
                    <input type="checkbox" class="completion-checkbox form-check-input" data-audio-id-chk="{{ audio.id }}" disabled style="margin-right: 10px;" />
                    {{ audio.transcript }}
                </p>
                <audio id="audio_player_{{ audio.id }}">
                    <source src="{% static audio.file %}" type="audio/wav">
                </audio>
                <audio id="recording_player_{{ audio.id }}">
                    {% if recording_signed_url %}
                        <source src="{{ recording_signed_url }}" type="audio/wav">
                    {% endif %}
                </audio>
                <div class="mt-2">
                    <button class="playReferenceBtn btn btn-primary btn-sm me-2" data-audio-id-ref="{{ audio.id }}">再生</button>
                    <button class="recordBtn btn btn-danger btn-sm me-2" data-audio-id-rec="{{ audio.id }}" disabled>録音開始</button>
                    <button class="playRecordingBtn btn btn-sm me-2 {% if recording_signed_url %}btn-primary{% else %}btn-outline-secondary disabled pe-none{% endif %}" 
                        data-audio-id-playrec="{{ audio.id }}" {% if not recording_signed_url %}disabled{% endif %}>録音を再生</button>
                </div>
            </div>
        </div>
    {% endfor %}

    <div class="mt-4 mb-5 d-grid">
        <button id="completeTrainingBtn" class="btn btn-lg btn-outline-success disabled pe-none" disabled>セッション完了</button>
    </div>
</div>

<script src="{% static 'js/recorder.js' %}"></script>
<script>
const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
const sessionStatus = {};
let recorder, gumStream, audioContext;

function updateCheckbox(audioId, block) {
    const chk = block.querySelector('.completion-checkbox');
    if (chk && sessionStatus[audioId].recorded && sessionStatus[audioId].listened) {
        chk.checked = true;
    }
}

function updateSessionComplete() {
    const btn = document.getElementById('completeTrainingBtn');
    const allDone = Object.values(sessionStatus).every(s => s.listened && s.recorded);
    btn.disabled = !allDone;
    btn.classList.toggle('btn-success', allDone);
    btn.classList.toggle('btn-outline-success', !allDone);
    btn.classList.toggle('disabled', !allDone);
    btn.classList.toggle('pe-none', !allDone);
    if (allDone) {
        btn.onclick = () => {
            window.location.href = "{% url 'login:logout' %}?message=" + encodeURIComponent("練習セッションお疲れ様でした！");
        };
    }
}

function lockAllButtons(except = null) {
    document.querySelectorAll('.playReferenceBtn, .recordBtn, .playRecordingBtn').forEach(btn => {
        if (btn !== except) btn.disabled = true;
    });
}

function restoreAllButtons() {
    document.querySelectorAll('.audio-block').forEach(block => {
        const audioId = block.dataset.audioId;
        const refBtn = block.querySelector('.playReferenceBtn');
        const recBtn = block.querySelector('.recordBtn');
        const playBtn = block.querySelector('.playRecordingBtn');
        const hasRecording = !!block.querySelector(`#recording_player_${audioId} source[src]`);

        refBtn.disabled = false;
        if (sessionStatus[audioId]?.listened) recBtn.disabled = false;
        if (hasRecording) {
            playBtn.disabled = false;
            playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
            playBtn.classList.add('btn-primary');
        }
    });
}

document.querySelectorAll('.audio-block').forEach(block => {
    const audioId = block.dataset.audioId;
    sessionStatus[audioId] = { listened: false, recorded: false };

    const refBtn = block.querySelector('.playReferenceBtn');
    const recBtn = block.querySelector('.recordBtn');
    const playBtn = block.querySelector('.playRecordingBtn');

    if (block.querySelector(`#recording_player_${audioId} source[src]`)) {
        playBtn.disabled = false;
        playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
        playBtn.classList.add('btn-primary');
    }

    refBtn.onclick = () => {
        const player = document.getElementById(`audio_player_${audioId}`);
        refBtn.disabled = true;
        player.currentTime = 0;
        player.play();
        player.onended = () => {
            sessionStatus[audioId].listened = true;
            recBtn.disabled = false;
            refBtn.disabled = false;
            updateCheckbox(audioId, block);
            updateSessionComplete();
        };
    };

    recBtn.onclick = async () => {
        if (recBtn.dataset.state !== 'recording') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                gumStream = stream;
                const input = audioContext.createMediaStreamSource(stream);
                recorder = new Recorder(input, { numChannels: 1 });
                recorder.record();

                lockAllButtons(recBtn);
                recBtn.textContent = '録音停止';
                recBtn.dataset.state = 'recording';
            } catch (err) {
                alert("マイクにアクセスできませんでした。");
                console.error(err);
            }
        } else {
            recorder.stop();
            gumStream.getAudioTracks()[0].stop();
            recBtn.textContent = '処理中...';
            recBtn.disabled = true;

            recorder.exportWAV(async blob => {
                const formData = new FormData();
                formData.append('audio', blob, `train_rec_${audioId}.wav`);
                formData.append('reference_audio', audioId);
                formData.append('activity_type', 'train_record');

                try {
                    const res = await fetch('/record/1/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: formData
                    });
                    const data = await res.json();
                    if (res.ok && data.status === 'success' && data.recording.url) {
                        const player = document.getElementById(`recording_player_${audioId}`);
                        player.innerHTML = `<source src="${data.recording.url}" type="audio/wav">`;
                        player.load();

                        playBtn.disabled = false;
                        playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
                        playBtn.classList.add('btn-primary');

                        sessionStatus[audioId].recorded = true;
                        updateCheckbox(audioId, block);
                        updateSessionComplete();
                    } else {
                        alert("録音の保存に失敗しました。");
                    }
                } catch (err) {
                    alert("エラーが発生しました。");
                    console.error(err);
                }

                recBtn.textContent = '録音開始';
                recBtn.dataset.state = 'idle';
                recBtn.disabled = false;
                restoreAllButtons();
            });
        }
    };

    playBtn.onclick = () => {
        const player = document.getElementById(`recording_player_${audioId}`);
        player.currentTime = 0;
        player.play();
    };
});
</script>
{% endblock %}
