{% extends 'login/base.html' %}

{% block content %}
    <h1>Practice Session</h1>

    {% for audio, recording in train_set %}
    
        {% csrf_token %}

        <div class="audio-block" data-audio-id="{{ audio.id }}">

            <p>{{ audio.transcript }}</p>

            <audio id="audio_{{ audio.id }}">
                <source src="{{ audio.file.url }}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
            
            <button onclick="document.getElementById('audio_{{ audio.id }}').play(); logActivity('{{ audio.id }}', 'train_listen_ref')">Play</button>

            <button class="startBtn">Start Recording</button>
            <button class="stopBtn" disabled>Stop Recording</button>

            <audio id="recording_{{ recording.id }}">
                <source src="{{ recording.recorded_audio.url }}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
            
            <button onclick="document.getElementById('recording_{{ recording.id }}').play(); logActivity('{{ recording.id }}', 'train_listen_own')">Play recording</button>

        </div>

        <hr>

    {% endfor %}

    <script>
        function logActivity(audioSourceId, typeCode) {
            console.log("Logging activity:", { audioSourceId, typeCode });
            fetch("/practice/log-activity/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    audio_source_id: audioSourceId,
                    type: typeCode
                })
            });
        }

        let mediaRecorder;
        let audioChunks = [];
        let currentAudioId = null;
        let activity_type = 'train_record'

        document.querySelectorAll('.startBtn').forEach((startBtn, index) => {
            const stopBtn = document.querySelectorAll('.stopBtn')[index];
            const audioBlock = startBtn.closest('.audio-block');
            const audioId = audioBlock.dataset.audioId;

            startBtn.onclick = async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                currentAudioId = audioId;

                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', blob, 'recorded.wav');
                    formData.append('reference_audio', currentAudioId);
                    formData.append('activity_type', activity_type)

                    const response = await fetch('/record/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        // Update the "Play recording" audio block
                        const recording = data.recording;
                        const audioBlock = document.querySelector(`.audio-block[data-audio-id="${currentAudioId}"]`);

                        const audioElement = audioBlock.querySelector('audio[id^="recording_"]');
                        const sourceElement = audioElement.querySelector('source');

                        audioElement.id = `recording_${recording.id}`;
                        sourceElement.src = recording.url;
                        audioElement.load(); 

                        const playBtn = audioBlock.querySelector('button[onclick*="train_listen_own"]');
                        playBtn.setAttribute('onclick', `document.getElementById('recording_${recording.id}').play(); logActivity('${recording.id}', 'train_listen_own')`);
                    }

                    audioChunks = [];
                };

                mediaRecorder.start();
                stopBtn.disabled = false;
            };

            stopBtn.onclick = () => {
                mediaRecorder.stop();
                stopBtn.disabled = true;
            };
        });
    </script>

    
{% endblock %}
