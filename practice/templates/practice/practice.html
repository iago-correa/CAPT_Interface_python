{% extends 'login/base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h1>練習セッション {{ period|add:1 }}</h1>

    <div id="train_complete_msg" class="alert alert-success" role="alert" style="visibility: hidden; display: none">
        <p class="mb-0"> この練習セッションは既に完了しています。</p>
        <p class="mb-0"> 引き続きこのページで練習を続けたい場合は、そのままご利用いただけます。</p>
        <p class="mb-0"> 練習を終了する場合は、「セッション終了」ボタンを押してください。セッションを終了した後でも、期間中であれば再度ログインして練習を続けることが可能です。</p>
    </div>

    <div class="accordion mb-3">
        <details class="accordion-item">
          <summary class="accordion-button">
            <div class="accordion-header">
                <h4>練習の進め方</h4>
            </div>
          </summary>
      
          <div class="accordion-body">
                <p class="mb-0">まずお手本の音声（「再生」ボタン）を聞いてから、ご自身の発音を録音（「録音開始」ボタン）してください。録音した音声は「録音を再生」ボタンで確認できます。</p>
                <hr>
                <p class="mb-0">お手本の再生、ご自身の録音、録音の再生は、何度でも繰り返し行うことができます。ただし、各課題を完了させるには、最低一回ずつお手本を聞き、ご自身の音声を録音する必要があります。</p>
                <p class="mb-0">完了した課題には、チェックマークが表示されます。すべての課題を完了させると、「セッション終了」ボタンが押せるようになり、セッションを終了することができます。</p>
                <p class="mb-0">すべての課題を完了した後でも、すぐにセッションを終了せず、続けて練習していただいて構いません。また、期間中であれば、セッションを終了した後でも再度ログインし、練習ページを利用することが可能です。</p>
                <p class="mb-0">一度ページを閉じて再度アクセスすることで、途中から練習を再開できます。</p>
                <hr>
                <p class="mb-0">前回のセッションで、iPhoneやiPadなどAppleの端末で問題が報告されています。同様の端末をご利用の方で録音に問題が発生した場合は、PCなど別の端末からのアクセスをお試しください。</p>
                <hr>
                <p class="mb-0">問題や不具合が発生した場合は、以下のメールアドレスまでご連絡ください。</p>
                <p class="mb-0 text-decoration-underline">i.lourencocorrea.747@stn.nitech.ac.jp</p>
                <p class="mb-0">メールご連絡の際は、学生番号、エラーの内容と発生した状況をできるだけ詳しくお知らせください。</p>
          </div>
        </details>
    </div>

    {% for audio, recording, recording_signed_url, checked in train_set %}
        {% if forloop.first %}{% csrf_token %}{% endif %}
        <div class="audio-block card mb-3" data-audio-id="{{ audio.id }}">
            <div class="card-body">
                <p class="mb-3">
                    <input type="checkbox" 
                           class="completion-checkbox form-check-input" 
                           data-audio-id-chk="{{ audio.id }}" 
                           data-is-checked="{{ checked|yesno:'true,false' }}"
                           style="margin-right: 10px;"
                           {% if checked %}checked{% endif %} 
                           disabled />
                    {{ audio.transcript }}
                </p>
                <audio id="audio_player_{{ audio.id }}">
                    <source src="{% static audio.file %}" type="audio/wav">
                </audio>
                <audio id="recording_player_{{ audio.id }}">
                    {% if recording_signed_url %}
                        <source src="{{ recording_signed_url }}" type="audio/wav">
                    {% endif %}
                </audio>
                <div class="mt-2">
                    <button class="playReferenceBtn btn btn-primary btn-sm me-2" data-audio-id-ref="{{ audio.id }}">再生</button>
                    <button class="recordBtn btn btn-danger btn-sm me-2" data-audio-id-rec="{{ audio.id }}" disabled>録音開始</button>
                    <button class="playRecordingBtn btn btn-sm me-2 {% if recording_signed_url %}btn-primary{% else %}btn-outline-secondary disabled pe-none{% endif %}" 
                            data-audio-id-playrec="{{ audio.id }}"
                            {% if recording %}data-recording-id="{{ recording.id }}"{% endif %}
                            {% if not recording_signed_url %}disabled{% endif %}>
                        録音を再生
                    </button>
                </div>
            </div>
        </div>
    {% endfor %}

    <div class="mt-4 mb-5 d-grid">
        <button id="completeTrainingBtn" class="btn btn-lg btn-outline-success disabled pe-none" disabled>セッション終了</button>
    </div>
</div>

<script src="{% static 'js/recorder.js' %}"></script>
<script>
const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
const sessionStatus = {};
const currentT = {{ period }};
let recorder, gumStream, audioContext;

window.onload = function() {
    updateSessionComplete();
  };

function updateCheckbox(audioId, block) {
    const chk = block.querySelector('.completion-checkbox');
    if (chk && sessionStatus[audioId].recorded && sessionStatus[audioId].listened) {
        chk.checked = true;
    }
}

function areAllCheckboxesChecked(className) {
    const checkboxes = document.querySelectorAll(`input[type="checkbox"].${className}`);
    return Array.from(checkboxes).every(checkbox => checkbox.checked);
}

function updateSessionComplete() {
    const btn = document.getElementById('completeTrainingBtn');    
    const div = document.getElementById('train_complete_msg');
    const allChecked = areAllCheckboxesChecked('completion-checkbox');
    // const allDone = Object.values(sessionStatus).every(s => s.listened && s.recorded);
    console.log(allChecked);
    // console.log(allDone)
    btn.disabled = !allChecked;
    btn.classList.toggle('btn-success', allChecked);
    btn.classList.toggle('btn-outline-success', !allChecked);
    btn.classList.toggle('disabled', !allChecked);
    btn.classList.toggle('pe-none', !allChecked);
    if (allChecked) {
        div.style.visibility = 'visible';
        div.style.display = 'block'
        btn.onclick = () => {
            window.location.href = "{% url 'login:logout' %}?message=" + encodeURIComponent("練習セッションお疲れ様でした！");
        };
    }
}

function lockAllButtons(except = null) {
    document.querySelectorAll('.playReferenceBtn, .recordBtn, .playRecordingBtn').forEach(btn => {
        if (btn !== except) btn.disabled = true;
    });
}

function restoreAllButtons() {
    document.querySelectorAll('.audio-block').forEach(block => {
        const audioId = block.dataset.audioId;
        const refBtn = block.querySelector('.playReferenceBtn');
        const recBtn = block.querySelector('.recordBtn');
        const playBtn = block.querySelector('.playRecordingBtn');
                
        refBtn.disabled = false;
        recBtn.disabled = !sessionStatus[audioId]?.listened;

        const hasRecording = !!block.querySelector(`#recording_player_${audioId} source[src]`);
        if (hasRecording) {
            playBtn.disabled = false;
            playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
            playBtn.classList.add('btn-primary');
        } else {
            playBtn.disabled = true;
            playBtn.classList.add('btn-outline-secondary', 'disabled', 'pe-none');
            playBtn.classList.remove('btn-primary');
        }
    });
}

document.querySelectorAll('.audio-block').forEach(block => {
    const audioId = block.dataset.audioId;
    const chk = block.querySelector('.completion-checkbox');
    const recBtn = block.querySelector('.recordBtn');

    const isCheckedFromServer = chk.dataset.isChecked === 'true';

    if (isCheckedFromServer) {
        sessionStatus[audioId] = { listened: true, recorded: true };
    } else {
        sessionStatus[audioId] = { listened: false, recorded: false };
    }

    chk.checked = sessionStatus[audioId].listened && sessionStatus[audioId].recorded;
    recBtn.disabled = !sessionStatus[audioId].listened;

    const refBtn = block.querySelector('.playReferenceBtn');
    const playBtn = block.querySelector('.playRecordingBtn');

    if (block.querySelector(`#recording_player_${audioId} source[src]`)) {
        playBtn.disabled = false;
        playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
        playBtn.classList.add('btn-primary');
    }

    refBtn.onclick = () => {
        const player = document.getElementById(`audio_player_${audioId}`);
        refBtn.disabled = true;
        player.currentTime = 0;
        player.play();
        player.onended = () => {
            sessionStatus[audioId].listened = true;
            recBtn.disabled = false;
            refBtn.disabled = false;
            updateCheckbox(audioId, block);
            updateSessionComplete();

            // Log activity: train_listen_ref
            fetch("{% url 'practice:log_activity' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    type: "train_listen_ref",
                    audio_source_id: audioId,
                }),
            });
        };
    };

    recBtn.onclick = async () => {
        if (recBtn.dataset.state !== 'recording') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                gumStream = stream;
                const input = audioContext.createMediaStreamSource(stream);
                recorder = new Recorder(input, { numChannels: 1 });
                recorder.record();

                lockAllButtons(recBtn);
                recBtn.textContent = '録音停止';
                recBtn.dataset.state = 'recording';
            } catch (err) {
                alert("マイクにアクセスできませんでした。");
                console.error(err);
            }
        } else {
            recorder.stop();
            gumStream.getAudioTracks()[0].stop();
            recBtn.textContent = '処理中.';
            recBtn.disabled = true;

            recorder.exportWAV(async blob => {
                const formData = new FormData();
                formData.append('audio', blob, `train_rec_${audioId}.wav`);
                formData.append('reference_audio', audioId);
                formData.append('activity_type', 'train_record');

                try {
                    const res = await fetch(`/record/${currentT}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: formData
                    });
                    const data = await res.json();
                    if (res.ok && data.status === 'success' && data.recording.url) {
                        const player = document.getElementById(`recording_player_${audioId}`);
                        player.innerHTML = `<source src="${data.recording.url}" type="audio/wav">`;
                        player.load();

                        playBtn.disabled = false;
                        playBtn.classList.remove('btn-outline-secondary', 'disabled', 'pe-none');
                        playBtn.classList.add('btn-primary');
                        playBtn.setAttribute("data-recording-id", data.recording.id);

                        sessionStatus[audioId].recorded = true;
                        updateCheckbox(audioId, block);
                        updateSessionComplete();
                    } else {
                        alert("録音の保存に失敗しました。");
                    }
                } catch (err) {
                    alert("エラーが発生しました。\n明細：" + err.message);
                    console.error(err);
                }

                recBtn.textContent = '録音開始';
                recBtn.dataset.state = 'idle';
                recBtn.disabled = false;
                restoreAllButtons();
            });
        }
    };

    playBtn.onclick = () => {
        const player = document.getElementById(`recording_player_${audioId}`);
        player.currentTime = 0;
        player.play();

        // Log activity: train_listen_own
        fetch("{% url 'practice:log_activity' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
                type: "train_listen_own",
                audio_source_id: playBtn.dataset.recordingId,
            }),
        });
    };
});
</script>
{% endblock %}
